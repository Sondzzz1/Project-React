<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p - B·ªánh Vi·ªán ƒêa Khoa</title>
    
    <link rel="stylesheet" href="../icon/themify-icons/themify-icons.css">
    <link rel="stylesheet" href="../css/login.css">
    <!-- AngularJS -->
    <script src="../angular/angular.min.js"></script>
    <script src="../js/api.service.js"></script>
</head>
<body>
    <div class="login-container" ng-controller="LoginController">
        <div class="login-box">
            <div class="login-header">
                <div class="logo-icon">
                    <i class="ti-pulse"></i>
                </div>
                <h2>B·ªánh Vi·ªán ƒêa Khoa</h2>
                <p>H·ªá th·ªëng qu·∫£n l√Ω b·ªánh vi·ªán</p>
            </div>
            
            <!-- Error Message -->
            <div class="error-message-box" ng-if="errorMessage">
                <i class="ti-alert"></i> {{errorMessage}}
            </div>
            
            <form id="loginForm" ng-submit="handleLogin()">
                <div class="form-group">
                    <label for="username">
                        <i class="ti-user"></i> T√™n ƒëƒÉng nh·∫≠p
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username"
                        ng-model="credentials.username"
                        ng-change="clearError()"
                        required 
                        placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                        autocomplete="username"
                    >
                </div>
                
                <div class="form-group">
                    <label for="password">
                        <i class="ti-lock"></i> M·∫≠t kh·∫©u
                    </label>
                    <div class="password-input-wrapper">
                        <input 
                            type="{{showPassword ? 'text' : 'password'}}" 
                            id="password" 
                            name="password"
                            ng-model="credentials.password"
                            ng-change="clearError()"
                            required 
                            placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                            autocomplete="current-password"
                        >
                        <button type="button" class="toggle-password" ng-click="togglePassword()">
                            <i ng-class="showPassword ? 'ti-eye-close' : 'ti-eye'"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="role">
                        <i class="ti-id-badge"></i> Vai tr√≤ / Quy·ªÅn truy c·∫≠p
                    </label>
                    <div class="select-wrapper">
                        <select id="role" name="role" ng-model="credentials.role" required>
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            <option value="admin">
                                üë®‚Äçüíº Qu·∫£n tr·ªã vi√™n (Admin)
                            </option>
                            <option value="doctor">
                                üë®‚Äç‚öïÔ∏è B√°c sƒ©
                            </option>
                            <option value="nurse">
                                üë©‚Äç‚öïÔ∏è Y t√°
                            </option>
                            <option value="caregiver">
                                üè• ƒêi·ªÅu d∆∞·ª°ng
                            </option>
                            <option value="accountant">
                                üí∞ K·∫ø to√°n
                            </option>
                            <option value="patient">
                                üë§ B·ªánh nh√¢n
                            </option>
                        </select>
                        <i class="ti-angle-down select-arrow"></i>
                    </div>
                    <small class="form-hint">Vui l√≤ng ch·ªçn vai tr√≤ c·ªßa b·∫°n trong h·ªá th·ªëng</small>
                </div>
                
                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="rememberMe" ng-model="rememberMe">
                        <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                    </label>
                    <a href="forgot_password.html" class="forgot-password">Qu√™n m·∫≠t kh·∫©u?</a>
                </div>
                
                <button type="submit" class="btn-login" ng-class="{'loading': isLoading}" ng-disabled="isLoading">
                    <i ng-class="isLoading ? 'ti-reload' : 'ti-unlock'"></i>
                    <span>{{isLoading ? 'ƒêang ƒëƒÉng nh·∫≠p...' : 'ƒêƒÉng nh·∫≠p'}}</span>
                </button>
            
            <div class="login-footer">
                <p>Ch∆∞a c√≥ t√†i kho·∫£n? <a href="./register.html">ƒêƒÉng k√Ω ngay</a></p>
            </div>
        </div>
    </div>
    
    <script src="../js/auth.js"></script>
    <script>
        /**
         * =============================================
         * LOGIN PAGE ANGULAR CONTROLLER
         * =============================================
         */
        
        // Extend hospitalApp module v·ªõi LoginController
        angular.module('hospitalApp')
        .controller('LoginController', [
            '$scope',
            '$window',
            'AuthService',
            function($scope, $window, AuthService) {
                
                // ============================================
                // SCOPE VARIABLES
                // ============================================
                
                $scope.credentials = {
                    username: '',
                    password: '',
                    role: ''
                };
                
                $scope.rememberMe = false;
                $scope.isLoading = false;
                $scope.errorMessage = '';
                $scope.showPassword = false;
                
                // ============================================
                // INITIALIZATION
                // ============================================
                
                function init() {
                    // KH√îNG t·ª± ƒë·ªông redirect - lu√¥n ·ªü l·∫°i trang login
                    // X√≥a h·∫øt data c≈© ƒë·ªÉ tr√°nh v√≤ng l·∫∑p
                    $window.localStorage.removeItem('jwt_token');
                    $window.localStorage.removeItem('current_user');
                    $window.sessionStorage.removeItem('currentUser');
                    
                    console.log('Login page initialized - all old session data cleared');
                    
                    // Load remembered username (ch·ªâ username, kh√¥ng redirect)
                    loadRememberedUser();
                }
                
                function loadRememberedUser() {
                    var remembered = $window.localStorage.getItem('rememberUser');
                    if (remembered) {
                        try {
                            var user = JSON.parse(remembered);
                            $scope.credentials.username = user.username || '';
                            $scope.credentials.role = user.role || '';
                            $scope.rememberMe = true;
                        } catch (e) {
                            // Ignore
                        }
                    }
                }
                
                // ============================================
                // LOGIN FUNCTION
                // ============================================
                
                $scope.handleLogin = function() {
                    // Validate
                    if (!$scope.credentials.username || 
                        !$scope.credentials.password || 
                        !$scope.credentials.role) {
                        $scope.errorMessage = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒëƒÉng nh·∫≠p!';
                        return;
                    }
                    
                    $scope.errorMessage = '';
                    $scope.isLoading = true;
                    
                    // Th·ª≠ g·ªçi API th·ª±c
                    AuthService.login(
                        $scope.credentials.username,
                        $scope.credentials.password
                    )
                    .then(function(response) {
                        // ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi API
                        handleLoginSuccess(response);
                    })
                    .catch(function(error) {
                        // API tr·∫£ v·ªÅ l·ªói
                        console.error('Login failed:', error);
                        $scope.isLoading = false;
                        $scope.errorMessage = error.data?.message || 
                            'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i! Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u.';
                    });
                };
                
                function handleLoginSuccess(response) {
                    console.log('Login response:', response);
                    
                    // L∆∞u remember me
                    if ($scope.rememberMe) {
                        $window.localStorage.setItem('rememberUser', JSON.stringify({
                            username: $scope.credentials.username,
                            role: $scope.credentials.role
                        }));
                    } else {
                        $window.localStorage.removeItem('rememberUser');
                    }
                    
                    // L·∫•y user info t·ª´ response
                    // Response format: { success, message, data: { token, ... } }
                    var userData = response.data || response;
                    console.log('User data:', userData);
                    
                    var userInfo = {
                        id: userData.maNguoiDung || userData.id,
                        username: userData.tenDangNhap || $scope.credentials.username,
                        hoTen: userData.hoTen || userData.tenDangNhap || $scope.credentials.username,
                        role: userData.vaiTro || $scope.credentials.role,
                        email: userData.email
                    };
                    
                    console.log('Saving user info:', userInfo);
                    $window.sessionStorage.setItem('currentUser', JSON.stringify(userInfo));
                    
                    // Redirect
                    $window.location.href = 'admin.html';
                }
                
                // ============================================
                // UI HELPERS
                // ============================================
                
                $scope.togglePassword = function() {
                    $scope.showPassword = !$scope.showPassword;
                };
                
                $scope.clearError = function() {
                    $scope.errorMessage = '';
                };
                
                // ============================================
                // INIT
                // ============================================
                
                init();
            }
        ]);
        
        // Bootstrap Angular app manually sau khi DOM loaded
        angular.element(document).ready(function() {
            // Check if already bootstrapped
            if (!angular.element(document.querySelector('.login-container')).scope()) {
                angular.bootstrap(document, ['hospitalApp']);
            }
        });
    </script>
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .error-message-box {
            background-color: #ffe6e6;
            border: 1px solid #ff4444;
            color: #cc0000;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-login.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-login.loading i {
            animation: spin 1s linear infinite;
        }
    </style>
</body>
</html>

